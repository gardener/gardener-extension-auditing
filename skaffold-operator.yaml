apiVersion: skaffold/v4beta12
kind: Config
metadata:
  name: operator
build:
  insecureRegistries:
    - garden.local.gardener.cloud:5001
  tagPolicy:
    customTemplate:
      template: "{{.version}}-{{.sha}}"
      components:
        - name: version
          envTemplate:
            template: "{{.EXTENSION_VERSION}}"
        # inputDigest is used to inject a digest of the artifact source into the built image tag
        # and therefore into the SKAFFOLD_IMAGE environment variable which is used when generating the corresponding ControllerDeployment
        - name: sha
          inputDigest: {}
  artifacts:
    - image: local-skaffold/gardener-extension-auditing
      ko:
        dependencies:
          paths:
            - cmd/gardener-extension-auditing
            - cmd/gardener-extension-auditing/app
            - imagevector
            - imagevector/images.yaml
            - pkg/apis/auditing
            - pkg/apis/auditing/install
            - pkg/apis/auditing/v1alpha1
            - pkg/apis/config
            - pkg/apis/config/v1alpha1
            - pkg/apis/config/validation
            - pkg/cmd
            - pkg/component/auditlog-forwarder
            - pkg/constants
            - pkg/controller/audit
            - pkg/controller/healthcheck
            - pkg/secrets
            - pkg/webhook/kapiserver
            - VERSION
        ldflags:
          - '{{.LD_FLAGS}}'
        main: ./cmd/gardener-extension-auditing
    - image: local-skaffold/gardener-extension-auditing-admission
      ko:
        dependencies:
          paths:
            - cmd/gardener-extension-auditing-admission
            - cmd/gardener-extension-auditing-admission/app
            - pkg/admission/cmd
            - pkg/admission/validator/secret
            - pkg/admission/validator/shoot
            - pkg/apis/auditing
            - pkg/apis/auditing/install
            - pkg/apis/auditing/v1alpha1
            - pkg/apis/auditing/validation
            - pkg/constants
            - VERSION
        ldflags:
          - '{{.LD_FLAGS}}'
        main: ./cmd/gardener-extension-auditing-admission
    - image: local-skaffold/echo-server
      ko:
        dependencies:
          paths:
            - cmd/echo-server
            - VERSION
        ldflags:
          - '{{.LD_FLAGS}}'
        main: ./cmd/echo-server
    - image: local-skaffold/gardener-extension-auditing-admission/charts/application
      custom:
        buildCommand: |
          bash "$GARDENER_HACK_DIR/push-helm.sh" ./charts/gardener-extension-auditing-admission/charts/application .image.ref
        dependencies:
          paths:
            - charts/gardener-extension-auditing-admission/charts/application
    - image: local-skaffold/gardener-extension-auditing-admission/charts/runtime
      custom:
        buildCommand: |
          bash "$GARDENER_HACK_DIR/push-helm.sh" ./charts/gardener-extension-auditing-admission/charts/runtime .image.ref
        dependencies:
          paths:
            - charts/gardener-extension-auditing-admission/charts/runtime
      requires:
        - image: local-skaffold/gardener-extension-auditing-admission
          alias: IMG
    - image: local-skaffold/gardener-extension-auditing/charts/extension
      custom:
        buildCommand: |
          bash "$GARDENER_HACK_DIR/push-helm.sh" ./charts/gardener-extension-auditing .image.ref
        dependencies:
          paths:
            - charts/gardener-extension-auditing
      requires:
        - image: local-skaffold/gardener-extension-auditing
          alias: IMG
manifests:
  rawYaml:
    - example/local-setup/operator-extension-resource.yaml
deploy:
  kubectl: {}
  helm:
    releases:
      - name: echo-server
        chartPath: example/local-setup/charts/echo-server
        valuesFiles:
          - example/local-setup/charts/echo-server/values.yaml
        namespace: echo-server
        setValueTemplates:
          image.repository: '{{.IMAGE_REPO_local_skaffold_echo_server}}'
          image.tag: '{{.IMAGE_TAG_local_skaffold_echo_server}}@{{.IMAGE_DIGEST_local_skaffold_echo_server}}'
        setFiles:
          certificates.ca.crt: example/local-setup/dev/certs/ca.crt
          certificates.tls.crt: example/local-setup/dev/certs/echo-server-tls.crt
          certificates.tls.key: example/local-setup/dev/certs/echo-server-tls.key
        createNamespace: true
        wait: true
    hooks:
      before:
        - host:
            command:
              - bash
              - -ec
              - hack/cert-gen.sh
resourceSelector:
  allow:
    - groupKind: Extension.operator.gardener.cloud
      image:
        - .spec.deployment.extension.helm.ociRepository.ref
        - .spec.deployment.admission.runtimeCluster.helm.ociRepository.ref
        - .spec.deployment.admission.virtualCluster.helm.ociRepository.ref
